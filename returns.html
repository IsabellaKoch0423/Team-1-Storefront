<!DOCTYPE html>
<html lang="en" ng-app="returnsApp">
<head>
    <meta charset="UTF-8">
    <title>Returns - TechNova</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css" />

    <!-- Author: Isabella Koch and Abdallah zakaria-->
    <style>
        body {
            background-color: #f4f6f8;
            color: #333;
        }
        header {
            background-color: #0d1b2a;
            color: #fff;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        nav {
            background-color: #1b263b;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px 0;
        }
        nav a {
            color: #e0e1dd;
            text-decoration: none;
            font-weight: bold;
        }
        nav a:hover {
            color: #ffb703;
        }
        form {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .invalid-feedback {
            display: block;
            color: red;
        }
        footer a {
            color: #0077b6;
            text-decoration: none;
        }
        footer a:hover {
            color: #023e8a;
        }
    </style>
</head>
<body>
<header>
    <h1>TechNova</h1>
</header>
<!-- Author: Isabella Koch -->
<nav>
    <a href="index.html">Home</a>
    <a href="#">About Us</a>
    <a href="shopping-cart.html">My Cart</a>
    <a href="product-management.html">Products</a>
    <a href="returns.html">Returns</a>
    <a href="#">Contact Us</a>
</nav>
<!-- Author: Isabella Koch and Sierra Matthews-->
<main class="container my-5" ng-controller="ReturnsController">
    <h2 class="text-center mb-4">Handle Returns</h2>

    <div class="mb-4 mx-auto" style="max-width: 600px;">
        <label class="form-label">Search Product by Name</label>
        <input type="text" class="form-control" ng-model="searchQuery" placeholder="Enter product name" ng-change="searchProducts()">
    </div>

    <ul class="list-group mb-3" ng-if="products.length > 0">
        <li class="list-group-item d-flex justify-content-between align-items-center" ng-repeat="product in products">
            <div>
                {{ product.productDesc }} - {{ product.productUOM }} - ${{ product.productPrice }}
            </div>
            <div class="d-flex gap-2">
                <input type="number" class="form-control" style="width: 80px;" ng-model="product.returnQty" min="1" placeholder="Qty">
                <button class="btn btn-sm btn-outline-primary" ng-click="addToReturn(product)">Add</button>
            </div>
        </li>
    </ul>

    <!-- Author: Sierra Matthews-->
    <h5>Return Cart</h5>
    <ul class="list-group mb-3" ng-if="returnCart.length > 0">
        <li class="list-group-item d-flex justify-content-between align-items-center" ng-repeat="item in returnCart">
            {{ item.productDesc }} - Qty: {{ item.returnQty }} - {{ item.productUOM }} - ${{ item.productPrice }}
            <button class="btn btn-sm btn-outline-danger" ng-click="removeFromReturn(item)">Remove</button>
        </li>
    </ul>

    <button class="btn btn-warning w-100" ng-disabled="returnCart.length === 0" ng-click="submitReturn()">
        Submit Return
    </button>


    <div ng-show="showReturnJSON" class="mt-4 bg-light p-3 rounded border">
        <h5>Return JSON:</h5>
        <pre>{{ returnInfo | json }}</pre>
    </div>
</main>

<footer class="bg-light text-center py-3">
    <p>
        <a href="terms.html">Terms of Use</a> |
        <a href="privacy.html">Cookie & Privacy Policy</a>
    </p>
    <p>&copy; 2025 TechNova. All rights reserved.</p>
</footer>
<!-- Author: Isabella Koch, abdallah zakaria,Sierra Matthews -->
<script>
    var app = angular.module('returnsApp', []);

    app.controller('ReturnsController', ['$scope', function($scope) {
        $scope.allProducts = [
            { productid: "1", productDesc: "TechNova Go 13.3\" Laptop", productUOM: "Piece", productPrice: 199.99 },
            { productid: "2", productDesc: "TechNova ProBook 15.6\" Laptop", productUOM: "Piece", productPrice: 329.99 },
            { productid: "3", productDesc: "NovaMini Desktop PC", productUOM: "Piece", productPrice: 259.99 },
            { productid: "4", productDesc: "NovaTab 8 Android Tablet", productUOM: "Piece", productPrice: 99.99 },
            { productid: "5", productDesc: "NovaPhone Air 5G", productUOM: "Piece", productPrice: 199.99 },
            { productid: "6", productDesc: "NovaPhone Lite 4G", productUOM: "Piece", productPrice: 139.99 },
            { productid: "7", productDesc: "NovaPlay Compact Controller", productUOM: "Piece", productPrice: 14.99 },
            { productid: "8", productDesc: "NovaBox Lite Console", productUOM: "Piece", productPrice: 169.99 },
            { productid: "9", productDesc: "NovaSound Essential Headset", productUOM: "Piece", productPrice: 18.99 },
            { productid: "10", productDesc: "NovaCharge Dual Dock", productUOM: "Piece", productPrice: 12.99 },
            { productid: "11", productDesc: "NovaHome Mini Smart Speaker", productUOM: "Piece", productPrice: 11.99 },
            { productid: "12", productDesc: "NovaPlug Wi-Fi Smart Outlet (2-Pack)", productUOM: "Pack", productPrice: 14.99 },
            { productid: "13", productDesc: "NovaGuard Basic Antivirus (1-Year)", productUOM: "Box", productPrice: 9.99 },
            { productid: "14", productDesc: "NovaDrive 500GB Portable SSD", productUOM: "Piece", productPrice: 39.99 },
            { productid: "15", productDesc: "NovaCam 1080p Webcam", productUOM: "Piece", productPrice: 24.99 },
            { productid: "16", productDesc: "NovaLight RGB Desk Lamp", productUOM: "Piece", productPrice: 19.99 }
        ];

        $scope.products = [];
        $scope.returnCart = [];
        $scope.showReturnJSON = false;

        $scope.searchProducts = function() {
            const query = $scope.searchQuery ? $scope.searchQuery.toLowerCase() : '';
            $scope.products = $scope.allProducts.filter(p => p.productDesc.toLowerCase().includes(query));
        };

        $scope.addToReturn = function(product) {
            if (!product.returnQty || product.returnQty < 1) {
                alert("Please enter a valid quantity.");
                return;
            }
            const existing = $scope.returnCart.find(p => p.productid === product.productid);
            if (existing) {
                existing.returnQty += product.returnQty;
            } else {
                $scope.returnCart.push({ ...product });
            }
            product.returnQty = null;
        };

        $scope.removeFromReturn = function(item) {
            $scope.returnCart = $scope.returnCart.filter(p => p.productid !== item.productid);
        };

        $scope.submitReturn = function() {
            $scope.returnInfo = {
                items: $scope.returnCart.map(p => ({
                    productid: p.productid,
                    productDesc: p.productDesc,
                    productUOM: p.productUOM,
                    productPrice: p.productPrice,
                    returnQty: p.returnQty
                }))
            };
            $scope.showReturnJSON = true;

            $.ajax({
                url: "https://130.203.136.203:3001/api/returns",
                method: "POST",
                data: JSON.stringify($scope.returnInfo),
                contentType: "application/json",
                crossDomain: true,
                success: function(response) {
                    console.log("Return saved:", response);
                    alert("Return submitted successfully!");
                },
                error: function(xhr, status, error) {
                    console.error("Failed to submit return:", error);
                    alert("‚ùå Failed to submit return to server (CORS or Node issue).");
                }
            });
        };
    }]);
</script>
</body>
</html>