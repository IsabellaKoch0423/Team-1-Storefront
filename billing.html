<!DOCTYPE html>
<html lang="en" ng-app="billingApp">
<head>
    <meta charset="UTF-8" />
    <title>Billing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.3/angular.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="styles.css" />

    <!-- Author: Isabella Koch and Abdallah zakaria -->
    <style>
        body {
            background-color: #f4f6f8;
            color: #333;
        }
        header {
            background-color: #0d1b2a;
            color: #fff;
            padding: 20px 40px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        nav {
            background-color: #1b263b;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px 0;
        }
        nav a {
            color: #e0e1dd;
            text-decoration: none;
            font-weight: bold;
        }
        nav a:hover {
            color: #ffb703;
        }
        form {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        .invalid-feedback {
            display: block;
            color: red;
        }
        footer a {
            color: #0077b6;
            text-decoration: none;
        }
        footer a:hover {
            color: #023e8a;
        }
    </style>
</head>
<body>
<header>
    <h1>TechNova</h1>
</header>
<!-- Author: Isabella Koch -->
<nav>
    <a href="index.html">Home</a>
    <a href="#">About Us</a>
    <a href="shopping-cart.html">My Cart</a>
    <a href="product-management.html">Products</a>
    <a href="returns.html">Returns</a>
    <a href="#">Contact Us</a>
</nav>
<!-- Author: Isabella Koch, Sierra Matthews -->
<main class="container my-5" ng-controller="BillingController">
    <h2 class="text-center mb-4">Billing Details</h2>
    <form name="billingForm" ng-submit="submitBilling()" novalidate class="mx-auto" style="max-width:600px;">

        <div class="form-check mb-3">
            <input type="checkbox" class="form-check-input" ng-model="sameAsShipping" ng-change="copyShippingToBilling()">
            <label class="form-check-label">Same as shipping address</label>
        </div>

        <div class="mb-3">
            <label class="form-label">Full Name</label>
            <input type="text" class="form-control" ng-model="billing.name" name="name" required />
            <div class="invalid-feedback" ng-show="billingForm.name.$touched && billingForm.name.$invalid">Name is required.</div>
        </div>
        <div class="mb-3">
            <label class="form-label">Billing Address</label>
            <input type="text" class="form-control" ng-model="billing.address" name="address" required />
            <div class="invalid-feedback" ng-show="billingForm.address.$touched && billingForm.address.$invalid">Address is required.</div>
        </div>
        <div class="mb-3">
            <label class="form-label">City</label>
            <input type="text" class="form-control" ng-model="billing.city" name="city" required />
        </div>
        <div class="mb-3 row">
            <div class="col-md-6">
                <label class="form-label">State</label>
                <input type="text" class="form-control" ng-model="billing.state" name="state" maxlength="2" required />
            </div>
            <div class="col-md-6">
                <label class="form-label">ZIP Code</label>
                <input type="text" class="form-control" ng-model="billing.zip" name="zip" ng-pattern="/^\d{5}$/" required />
                <div class="invalid-feedback" ng-show="billingForm.zip.$error.pattern">Must be 5 digits.</div>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label">Payment Method</label>
            <select class="form-select" ng-model="billing.paymentMethod" name="paymentMethod" required>
                <option value="">-- Select Payment Method --</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Debit Card">Debit Card</option>
            </select>
            <div class="invalid-feedback" ng-show="billingForm.paymentMethod.$touched && billingForm.paymentMethod.$invalid">Please select a payment method.</div>
        </div>

        <!-- Conditional Credit/Debit Card Fields -->
        <div ng-if="billing.paymentMethod === 'Credit Card' || billing.paymentMethod === 'Debit Card'">
            <div class="mb-3">
                <label class="form-label">Card Number</label>
                <input type="text" class="form-control" ng-model="billing.cardNumber" name="cardNumber" ng-pattern="/^\d{14,16}$/" required />
                <div class="invalid-feedback" ng-show="billingForm.cardNumber.$touched && billingForm.cardNumber.$error.pattern">Card number must be 14-16 digits..</div>
            </div>
            <div class="mb-3">
                <label class="form-label">Expiration Date</label>
                <input type="month" class="form-control" ng-model="billing.expiration" name="expiration" required />
                <div class="invalid-feedback" ng-show="billingForm.expiration.$touched && billingForm.expiration.$invalid">Expiration date is required.</div>
            </div>
            <div class="mb-3">
                <label class="form-label">CVV</label>
                <input type="text" class="form-control" ng-model="billing.cvv" name="cvv"  ng-pattern="/^\d{3,4}$/" maxlength="4" required />
                <div class="invalid-feedback" ng-show="billingForm.cvv.$touched && billingForm.cvv.$error.pattern">CVV must be 3 or 4 digits.</div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100" ng-disabled="billingForm.$invalid">Submit Billing</button>
    </form>

    <div ng-show="showBillingJSON" class="mt-4 bg-light p-3 rounded border">
        <h5>Billing JSON:</h5>
        <pre>{{ finalOrder | json }}</pre>
    </div>
</main>

<footer class="bg-light text-center py-3">
    <p>
        <a href="terms.html">Terms of Use</a> |
        <a href="privacy.html">Cookie & Privacy Policy</a> |
        <a href="copyright.html">Copyright</a>
    </p>
    <p>&copy; 2025 TechNova. All rights reserved.</p>
</footer>
<!-- Author: Sierra Matthews -->
<script>
    var app = angular.module('billingApp', []);

    app.controller('BillingController', ['$scope', function($scope) {

        var storedShipping = localStorage.getItem('shippingDetails');
        if (storedShipping) {
            $scope.shippingFromPreviousPage = JSON.parse(storedShipping);
        }

        $scope.billing = {};
        $scope.sameAsShipping = false;
        $scope.showBillingJSON = false;

        function maskCard(num) {
            if (!num) return "";
            return num.replace(/\d(?=\d{4})/g, "*");
        }

        $scope.copyShippingToBilling = function() {
            if ($scope.sameAsShipping && $scope.shippingFromPreviousPage) {
                $scope.billing.name = $scope.shippingFromPreviousPage.name;
                $scope.billing.address = $scope.shippingFromPreviousPage.address;
                $scope.billing.city = $scope.shippingFromPreviousPage.city;
                $scope.billing.state = $scope.shippingFromPreviousPage.state;
                $scope.billing.zip = $scope.shippingFromPreviousPage.zip;
            }
        };

        $scope.submitBilling = function() {
    if ($scope.billingForm.$valid) {

        $scope.billingInfo = angular.copy($scope.billing);

        $scope.billingInfo.cardNumber = maskCard($scope.billing.cardNumber.trim());

        if ($scope.billing.expiration instanceof Date) {
            $scope.billingInfo.expiration =
                $scope.billing.expiration.toISOString().slice(0,7);
        }

        delete $scope.billingInfo.cvv;

        $scope.finalOrder = {
            shipping: $scope.shippingFromPreviousPage,
            billing: $scope.billingInfo
        };

        $scope.showBillingJSON = true;

        // ✅ AJAX — SAME STYLE AS RETURNS PAGE
        $.ajax({
            url: "https://130.203.136.203:3001/api/billing",
            method: "POST",
            data: JSON.stringify($scope.finalOrder),
            contentType: "application/json",
            crossDomain: true,
            success: function(response) {
                console.log("Billing saved:", response);
                alert("Billing submitted successfully!");
            },
            error: function(xhr, status, error) {
                console.error("Failed to submit billing:", error);
                alert("❌ Failed to submit billing to server (CORS or Node issue).");
            }
        });

    } else {
        alert("Please correct the highlighted fields.");
    }
};

    }]);
</script>
</body>
</html>
